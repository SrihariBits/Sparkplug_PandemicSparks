{"ast":null,"code":"\"use strict\";\n\nvar _createClass = function () {\n  function defineProperties(target, props) {\n    for (var i = 0; i < props.length; i++) {\n      var descriptor = props[i];\n      descriptor.enumerable = descriptor.enumerable || false;\n      descriptor.configurable = true;\n      if (\"value\" in descriptor) descriptor.writable = true;\n      Object.defineProperty(target, descriptor.key, descriptor);\n    }\n  }\n\n  return function (Constructor, protoProps, staticProps) {\n    if (protoProps) defineProperties(Constructor.prototype, protoProps);\n    if (staticProps) defineProperties(Constructor, staticProps);\n    return Constructor;\n  };\n}();\n\nfunction _classCallCheck(instance, Constructor) {\n  if (!(instance instanceof Constructor)) {\n    throw new TypeError(\"Cannot call a class as a function\");\n  }\n}\n\nfunction _possibleConstructorReturn(self, call) {\n  if (!self) {\n    throw new ReferenceError(\"this hasn't been initialised - super() hasn't been called\");\n  }\n\n  return call && (typeof call === \"object\" || typeof call === \"function\") ? call : self;\n}\n\nfunction _inherits(subClass, superClass) {\n  if (typeof superClass !== \"function\" && superClass !== null) {\n    throw new TypeError(\"Super expression must either be null or a function, not \" + typeof superClass);\n  }\n\n  subClass.prototype = Object.create(superClass && superClass.prototype, {\n    constructor: {\n      value: subClass,\n      enumerable: false,\n      writable: true,\n      configurable: true\n    }\n  });\n  if (superClass) Object.setPrototypeOf ? Object.setPrototypeOf(subClass, superClass) : subClass.__proto__ = superClass;\n}\n\nimport React from 'react';\nimport PropTypes from 'prop-types';\nimport ReactDOM from 'react-dom';\nimport * as Three from 'three';\nimport { parseData, updateScene } from './scene-creator';\nimport { disposeScene } from './three-memory-cleaner';\nimport diff from 'immutablediff';\nimport { initPointerLock } from \"./pointer-lock-navigation\";\nimport { firstPersonOnKeyDown, firstPersonOnKeyUp } from \"./libs/first-person-controls\";\nimport * as SharedStyle from '../../shared-style';\n\nvar Viewer3DFirstPerson = function (_React$Component) {\n  _inherits(Viewer3DFirstPerson, _React$Component);\n\n  function Viewer3DFirstPerson(props) {\n    _classCallCheck(this, Viewer3DFirstPerson);\n\n    var _this = _possibleConstructorReturn(this, (Viewer3DFirstPerson.__proto__ || Object.getPrototypeOf(Viewer3DFirstPerson)).call(this, props));\n\n    _this.width = props.width;\n    _this.height = props.height;\n    _this.stopRendering = false;\n    _this.renderer = window.__threeRenderer || new Three.WebGLRenderer({\n      preserveDrawingBuffer: true\n    });\n    window.__threeRenderer = _this.renderer;\n    return _this;\n  }\n\n  _createClass(Viewer3DFirstPerson, [{\n    key: 'componentDidMount',\n    value: function componentDidMount() {\n      var _this2 = this;\n      /** Variables for movement control **/\n\n\n      var prevTime = performance.now();\n      var velocity = new Three.Vector3();\n      var direction = new Three.Vector3();\n      var moveForward = false;\n      var moveBackward = false;\n      var moveLeft = false;\n      var moveRight = false;\n      var canJump = false;\n      var catalog = this.context.catalog;\n      var actions = {\n        areaActions: this.context.areaActions,\n        holesActions: this.context.holesActions,\n        itemsActions: this.context.itemsActions,\n        linesActions: this.context.linesActions,\n        projectActions: this.context.projectActions\n      };\n      var state = this.props.state;\n      var data = state.scene;\n      var canvasWrapper = ReactDOM.findDOMNode(this.refs.canvasWrapper);\n      var scene3D = new Three.Scene(); // As I need to show the pointer above all scene objects, I use this workaround http://stackoverflow.com/a/13309722\n\n      var sceneOnTop = new Three.Scene(); //RENDERER\n\n      this.renderer.setClearColor(new Three.Color(SharedStyle.COLORS.white));\n      this.renderer.setSize(this.width, this.height); // LOAD DATA\n\n      this.planData = parseData(data, actions, catalog);\n      scene3D.add(this.planData.plan); // CAMERA\n\n      var aspectRatio = this.width / this.height;\n      var camera = new Three.PerspectiveCamera(45, aspectRatio, 0.1, 300000);\n      sceneOnTop.add(camera); // The pointer is on the camera so I show it above all\n      // Set position for the camera\n\n      camera.position.set(0, 0, 0);\n      camera.up = new Three.Vector3(0, 1, 0); // HELPER AXIS\n      // let axisHelper = new Three.AxisHelper(100);\n      // scene3D.add(axisHelper);\n      // LIGHT\n\n      var light = new Three.AmbientLight(0xafafaf); // soft white light\n\n      scene3D.add(light); // Add another light\n\n      var pointLight = new Three.PointLight(SharedStyle.COLORS.white, 0.4, 1000);\n      pointLight.position.set(0, 0, 0);\n      scene3D.add(pointLight); // POINTER LOCK\n\n      document.body.requestPointerLock = document.body.requestPointerLock || document.body.mozRequestPointerLock || document.body.webkitRequestPointerLock;\n      document.body.requestPointerLock();\n\n      var _initPointerLock = initPointerLock(camera, this.renderer.domElement),\n          controls = _initPointerLock.controls,\n          pointerlockChangeEvent = _initPointerLock.pointerlockChangeEvent,\n          requestPointerLockEvent = _initPointerLock.requestPointerLockEvent;\n\n      this.controls = controls;\n      this.pointerlockChangeListener = pointerlockChangeEvent;\n      this.requestPointerLockEvent = requestPointerLockEvent;\n      /* Set user initial position */\n\n      var humanHeight = 170; // 170 cm\n\n      var yInitialPosition = this.planData.boundingBox.min.y + (this.planData.boundingBox.min.y - this.planData.boundingBox.max.y) / 2 + humanHeight;\n      this.controls.getObject().position.set(-50, yInitialPosition, -100);\n      sceneOnTop.add(this.controls.getObject()); // Add the pointer lock controls to the scene that will be rendered on top\n      // Add move controls on the page\n\n      this.keyDownEvent = function (event) {\n        var moveResult = firstPersonOnKeyDown(event, moveForward, moveLeft, moveBackward, moveRight, canJump, velocity);\n        moveForward = moveResult.moveForward;\n        moveLeft = moveResult.moveLeft;\n        moveBackward = moveResult.moveBackward;\n        moveRight = moveResult.moveRight;\n        canJump = moveResult.canJump;\n      };\n\n      this.keyUpEvent = function (event) {\n        var moveResult = firstPersonOnKeyUp(event, moveForward, moveLeft, moveBackward, moveRight, canJump);\n        moveForward = moveResult.moveForward;\n        moveLeft = moveResult.moveLeft;\n        moveBackward = moveResult.moveBackward;\n        moveRight = moveResult.moveRight;\n        canJump = moveResult.canJump;\n      };\n\n      document.addEventListener('keydown', this.keyDownEvent);\n      document.addEventListener('keyup', this.keyUpEvent); // Add a pointer to the scene\n\n      var pointer = new Three.Object3D();\n      pointer.name = 'pointer';\n      var pointerMaterial = new Three.MeshBasicMaterial({\n        depthTest: false,\n        depthWrite: false,\n        color: SharedStyle.COLORS.black\n      });\n      var pointerGeometry1 = new Three.Geometry();\n      pointerGeometry1.vertices.push(new Three.Vector3(-10, 0, 0));\n      pointerGeometry1.vertices.push(new Three.Vector3(10, 0, 0));\n      var linePointer1 = new Three.Line(pointerGeometry1, pointerMaterial);\n      linePointer1.position.z -= 100;\n      var pointerGeometry2 = new Three.Geometry();\n      pointerGeometry2.vertices.push(new Three.Vector3(0, 10, 0));\n      pointerGeometry2.vertices.push(new Three.Vector3(0, -10, 0));\n      var linePointer2 = new Three.Line(pointerGeometry2, pointerMaterial);\n      linePointer2.renderDepth = 1e20;\n      linePointer2.position.z -= 100;\n      var pointerGeometry3 = new Three.Geometry();\n      pointerGeometry3.vertices.push(new Three.Vector3(-1, 1, 0));\n      pointerGeometry3.vertices.push(new Three.Vector3(1, 1, 0));\n      pointerGeometry3.vertices.push(new Three.Vector3(1, -1, 0));\n      pointerGeometry3.vertices.push(new Three.Vector3(-1, -1, 0));\n      pointerGeometry3.vertices.push(new Three.Vector3(-1, 1, 0));\n      var linePointer3 = new Three.Line(pointerGeometry3, pointerMaterial);\n      linePointer3.position.z -= 100;\n      pointer.add(linePointer1);\n      pointer.add(linePointer2);\n      pointer.add(linePointer3);\n      camera.add(pointer); // Add the pointer to the camera\n      // OBJECT PICKING\n\n      var toIntersect = [this.planData.plan];\n      var mouseVector = new Three.Vector2(0, 0);\n      var raycaster = new Three.Raycaster();\n\n      this.firstPersonMouseDown = function (event) {\n        // First of all I check if controls are enabled\n        if (_this2.controls.enabled) {\n          event.preventDefault();\n          /* Per avere la direzione da assegnare al raycaster, chiamo il metodo getDirection di PointerLockControls,\n           * che restituisce una funzione che a sua volta prende un vettore, vi scrive i valori degli oggetti\n           * pitch e yaw e lo restituisce */\n\n          raycaster.setFromCamera(mouseVector, camera);\n          var intersects = raycaster.intersectObjects(toIntersect, true);\n\n          if (intersects.length > 0 && !isNaN(intersects[0].distance)) {\n            intersects[0].object.interact && intersects[0].object.interact();\n          } else {\n            _this2.context.projectActions.unselectAll();\n          }\n        }\n      };\n\n      document.addEventListener('mousedown', this.firstPersonMouseDown, false);\n      this.renderer.domElement.style.display = 'block'; // add the output of the renderer to the html element\n\n      canvasWrapper.appendChild(this.renderer.domElement);\n      this.renderer.autoClear = false;\n\n      var render = function render() {\n        if (!_this2.stopRendering) {\n          yInitialPosition = _this2.planData.boundingBox.min.y + humanHeight;\n          var multiplier = 5;\n          var time = performance.now();\n          var delta = (time - prevTime) / 1000 * multiplier;\n          velocity.x -= velocity.x * 10.0 * delta;\n          velocity.z -= velocity.z * 10.0 * delta;\n          velocity.y -= 9.8 * 100.0 * delta / multiplier; // 100.0 = mass\n\n          direction.z = Number(moveForward) - Number(moveBackward);\n          direction.x = Number(moveLeft) - Number(moveRight);\n          direction.normalize(); // this ensures consistent movements in all directions\n\n          if (moveForward || moveBackward) velocity.z -= direction.z * 400.0 * delta;\n          if (moveLeft || moveRight) velocity.x -= direction.x * 400.0 * delta;\n\n          _this2.controls.getObject().translateX(velocity.x * delta);\n\n          _this2.controls.getObject().translateY(velocity.y * delta);\n\n          _this2.controls.getObject().translateZ(velocity.z * delta);\n\n          if (_this2.controls.getObject().position.y < yInitialPosition) {\n            velocity.y = 0;\n            _this2.controls.getObject().position.y = yInitialPosition;\n            canJump = true;\n          }\n\n          prevTime = time; // Set light position\n\n          var controlObjectPosition = _this2.controls.getObject().position;\n\n          pointLight.position.set(controlObjectPosition.x, controlObjectPosition.y, controlObjectPosition.z);\n\n          for (var elemID in _this2.planData.sceneGraph.LODs) {\n            _this2.planData.sceneGraph.LODs[elemID].update(camera);\n          }\n\n          _this2.renderer.clear(); // clear buffers\n\n\n          _this2.renderer.render(scene3D, camera); // render scene 1\n\n\n          _this2.renderer.clearDepth(); // clear depth buffer\n\n\n          _this2.renderer.render(sceneOnTop, camera); // render scene 2\n\n\n          requestAnimationFrame(render);\n        }\n      };\n\n      render();\n      this.camera = camera;\n      this.scene3D = scene3D;\n      this.sceneOnTop = sceneOnTop; // this.planData = planData;\n    }\n  }, {\n    key: 'componentWillUnmount',\n    value: function componentWillUnmount() {\n      this.stopRendering = true;\n      this.renderer.autoClear = true;\n      document.removeEventListener('mousedown', this.firstPersonMouseDown);\n      document.removeEventListener('keydown', this.keyDownEvent);\n      document.removeEventListener('keyup', this.keyUpEvent);\n      document.removeEventListener('pointerlockchange', this.pointerlockChangeEvent);\n      document.removeEventListener('mozpointerlockchange', this.pointerlockChangeEvent);\n      document.removeEventListener('webkitpointerlockchange', this.pointerlockChangeEvent);\n      this.renderer.domElement.removeEventListener('click', this.requestPointerLockEvent);\n      disposeScene(this.scene3D);\n      this.scene3D.remove(this.planData.plan);\n      this.scene3D = null;\n      this.planData = null;\n      this.renderer.renderLists.dispose();\n    }\n  }, {\n    key: 'componentWillReceiveProps',\n    value: function componentWillReceiveProps(nextProps) {\n      var width = nextProps.width,\n          height = nextProps.height;\n      var camera = this.camera,\n          renderer = this.renderer,\n          scene3D = this.scene3D,\n          sceneOnTop = this.sceneOnTop,\n          planData = this.planData;\n      var actions = {\n        areaActions: this.context.areaActions,\n        holesActions: this.context.holesActions,\n        itemsActions: this.context.itemsActions,\n        linesActions: this.context.linesActions,\n        projectActions: this.context.projectActions\n      };\n      this.width = width;\n      this.height = height;\n      camera.aspect = width / height;\n      camera.updateProjectionMatrix();\n\n      if (nextProps.scene !== this.props.state.scene) {\n        var changedValues = diff(this.props.state.scene, nextProps.state.scene);\n        updateScene(planData, nextProps.state.scene, this.props.state.scene, changedValues.toJS(), actions, this.context.catalog);\n      }\n\n      renderer.setSize(width, height);\n      renderer.clear(); // clear buffers\n\n      renderer.render(scene3D, camera); // render scene 1\n\n      renderer.clearDepth(); // clear depth buffer\n\n      renderer.render(sceneOnTop, camera); // render scene 2\n    }\n  }, {\n    key: 'render',\n    value: function render() {\n      return React.createElement(\"div\", {\n        ref: \"canvasWrapper\"\n      });\n    }\n  }]);\n\n  return Viewer3DFirstPerson;\n}(React.Component);\n\nexport default Viewer3DFirstPerson;\nViewer3DFirstPerson.propTypes = {\n  state: PropTypes.object.isRequired,\n  width: PropTypes.number.isRequired,\n  height: PropTypes.number.isRequired\n};\nViewer3DFirstPerson.contextTypes = {\n  areaActions: PropTypes.object.isRequired,\n  holesActions: PropTypes.object.isRequired,\n  itemsActions: PropTypes.object.isRequired,\n  linesActions: PropTypes.object.isRequired,\n  projectActions: PropTypes.object.isRequired,\n  catalog: PropTypes.object\n};","map":{"version":3,"sources":["/home/srihari/Desktop/Sparkplug_PandemicSparks/grid/node_modules/react-planner/es/components/viewer3d/viewer3d-first-person.js"],"names":["_createClass","defineProperties","target","props","i","length","descriptor","enumerable","configurable","writable","Object","defineProperty","key","Constructor","protoProps","staticProps","prototype","_classCallCheck","instance","TypeError","_possibleConstructorReturn","self","call","ReferenceError","_inherits","subClass","superClass","create","constructor","value","setPrototypeOf","__proto__","React","PropTypes","ReactDOM","Three","parseData","updateScene","disposeScene","diff","initPointerLock","firstPersonOnKeyDown","firstPersonOnKeyUp","SharedStyle","Viewer3DFirstPerson","_React$Component","_this","getPrototypeOf","width","height","stopRendering","renderer","window","__threeRenderer","WebGLRenderer","preserveDrawingBuffer","componentDidMount","_this2","prevTime","performance","now","velocity","Vector3","direction","moveForward","moveBackward","moveLeft","moveRight","canJump","catalog","context","actions","areaActions","holesActions","itemsActions","linesActions","projectActions","state","data","scene","canvasWrapper","findDOMNode","refs","scene3D","Scene","sceneOnTop","setClearColor","Color","COLORS","white","setSize","planData","add","plan","aspectRatio","camera","PerspectiveCamera","position","set","up","light","AmbientLight","pointLight","PointLight","document","body","requestPointerLock","mozRequestPointerLock","webkitRequestPointerLock","_initPointerLock","domElement","controls","pointerlockChangeEvent","requestPointerLockEvent","pointerlockChangeListener","humanHeight","yInitialPosition","boundingBox","min","y","max","getObject","keyDownEvent","event","moveResult","keyUpEvent","addEventListener","pointer","Object3D","name","pointerMaterial","MeshBasicMaterial","depthTest","depthWrite","color","black","pointerGeometry1","Geometry","vertices","push","linePointer1","Line","z","pointerGeometry2","linePointer2","renderDepth","pointerGeometry3","linePointer3","toIntersect","mouseVector","Vector2","raycaster","Raycaster","firstPersonMouseDown","enabled","preventDefault","setFromCamera","intersects","intersectObjects","isNaN","distance","object","interact","unselectAll","style","display","appendChild","autoClear","render","multiplier","time","delta","x","Number","normalize","translateX","translateY","translateZ","controlObjectPosition","elemID","sceneGraph","LODs","update","clear","clearDepth","requestAnimationFrame","componentWillUnmount","removeEventListener","remove","renderLists","dispose","componentWillReceiveProps","nextProps","aspect","updateProjectionMatrix","changedValues","toJS","createElement","ref","Component","propTypes","isRequired","number","contextTypes"],"mappings":"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","sourcesContent":["\"use strict\";\n\nvar _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if (\"value\" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();\n\nfunction _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError(\"Cannot call a class as a function\"); } }\n\nfunction _possibleConstructorReturn(self, call) { if (!self) { throw new ReferenceError(\"this hasn't been initialised - super() hasn't been called\"); } return call && (typeof call === \"object\" || typeof call === \"function\") ? call : self; }\n\nfunction _inherits(subClass, superClass) { if (typeof superClass !== \"function\" && superClass !== null) { throw new TypeError(\"Super expression must either be null or a function, not \" + typeof superClass); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, enumerable: false, writable: true, configurable: true } }); if (superClass) Object.setPrototypeOf ? Object.setPrototypeOf(subClass, superClass) : subClass.__proto__ = superClass; }\n\nimport React from 'react';\nimport PropTypes from 'prop-types';\nimport ReactDOM from 'react-dom';\nimport * as Three from 'three';\nimport { parseData, updateScene } from './scene-creator';\nimport { disposeScene } from './three-memory-cleaner';\nimport diff from 'immutablediff';\nimport { initPointerLock } from \"./pointer-lock-navigation\";\nimport { firstPersonOnKeyDown, firstPersonOnKeyUp } from \"./libs/first-person-controls\";\nimport * as SharedStyle from '../../shared-style';\n\nvar Viewer3DFirstPerson = function (_React$Component) {\n  _inherits(Viewer3DFirstPerson, _React$Component);\n\n  function Viewer3DFirstPerson(props) {\n    _classCallCheck(this, Viewer3DFirstPerson);\n\n    var _this = _possibleConstructorReturn(this, (Viewer3DFirstPerson.__proto__ || Object.getPrototypeOf(Viewer3DFirstPerson)).call(this, props));\n\n    _this.width = props.width;\n    _this.height = props.height;\n    _this.stopRendering = false;\n    _this.renderer = window.__threeRenderer || new Three.WebGLRenderer({ preserveDrawingBuffer: true });\n    window.__threeRenderer = _this.renderer;\n    return _this;\n  }\n\n  _createClass(Viewer3DFirstPerson, [{\n    key: 'componentDidMount',\n    value: function componentDidMount() {\n      var _this2 = this;\n\n      /** Variables for movement control **/\n      var prevTime = performance.now();\n      var velocity = new Three.Vector3();\n      var direction = new Three.Vector3();\n      var moveForward = false;\n      var moveBackward = false;\n      var moveLeft = false;\n      var moveRight = false;\n      var canJump = false;\n\n      var catalog = this.context.catalog;\n\n\n      var actions = {\n        areaActions: this.context.areaActions,\n        holesActions: this.context.holesActions,\n        itemsActions: this.context.itemsActions,\n        linesActions: this.context.linesActions,\n        projectActions: this.context.projectActions\n      };\n\n      var state = this.props.state;\n\n      var data = state.scene;\n      var canvasWrapper = ReactDOM.findDOMNode(this.refs.canvasWrapper);\n\n      var scene3D = new Three.Scene();\n\n      // As I need to show the pointer above all scene objects, I use this workaround http://stackoverflow.com/a/13309722\n      var sceneOnTop = new Three.Scene();\n\n      //RENDERER\n      this.renderer.setClearColor(new Three.Color(SharedStyle.COLORS.white));\n      this.renderer.setSize(this.width, this.height);\n\n      // LOAD DATA\n      this.planData = parseData(data, actions, catalog);\n\n      scene3D.add(this.planData.plan);\n\n      // CAMERA\n      var aspectRatio = this.width / this.height;\n      var camera = new Three.PerspectiveCamera(45, aspectRatio, 0.1, 300000);\n\n      sceneOnTop.add(camera); // The pointer is on the camera so I show it above all\n\n      // Set position for the camera\n      camera.position.set(0, 0, 0);\n      camera.up = new Three.Vector3(0, 1, 0);\n\n      // HELPER AXIS\n      // let axisHelper = new Three.AxisHelper(100);\n      // scene3D.add(axisHelper);\n\n      // LIGHT\n      var light = new Three.AmbientLight(0xafafaf); // soft white light\n      scene3D.add(light);\n\n      // Add another light\n      var pointLight = new Three.PointLight(SharedStyle.COLORS.white, 0.4, 1000);\n      pointLight.position.set(0, 0, 0);\n      scene3D.add(pointLight);\n\n      // POINTER LOCK\n\n      document.body.requestPointerLock = document.body.requestPointerLock || document.body.mozRequestPointerLock || document.body.webkitRequestPointerLock;\n\n      document.body.requestPointerLock();\n\n      var _initPointerLock = initPointerLock(camera, this.renderer.domElement),\n          controls = _initPointerLock.controls,\n          pointerlockChangeEvent = _initPointerLock.pointerlockChangeEvent,\n          requestPointerLockEvent = _initPointerLock.requestPointerLockEvent;\n\n      this.controls = controls;\n      this.pointerlockChangeListener = pointerlockChangeEvent;\n      this.requestPointerLockEvent = requestPointerLockEvent;\n\n      /* Set user initial position */\n      var humanHeight = 170; // 170 cm\n\n      var yInitialPosition = this.planData.boundingBox.min.y + (this.planData.boundingBox.min.y - this.planData.boundingBox.max.y) / 2 + humanHeight;\n      this.controls.getObject().position.set(-50, yInitialPosition, -100);\n      sceneOnTop.add(this.controls.getObject()); // Add the pointer lock controls to the scene that will be rendered on top\n\n      // Add move controls on the page\n      this.keyDownEvent = function (event) {\n        var moveResult = firstPersonOnKeyDown(event, moveForward, moveLeft, moveBackward, moveRight, canJump, velocity);\n        moveForward = moveResult.moveForward;\n        moveLeft = moveResult.moveLeft;\n        moveBackward = moveResult.moveBackward;\n        moveRight = moveResult.moveRight;\n        canJump = moveResult.canJump;\n      };\n\n      this.keyUpEvent = function (event) {\n        var moveResult = firstPersonOnKeyUp(event, moveForward, moveLeft, moveBackward, moveRight, canJump);\n        moveForward = moveResult.moveForward;\n        moveLeft = moveResult.moveLeft;\n        moveBackward = moveResult.moveBackward;\n        moveRight = moveResult.moveRight;\n        canJump = moveResult.canJump;\n      };\n\n      document.addEventListener('keydown', this.keyDownEvent);\n      document.addEventListener('keyup', this.keyUpEvent);\n\n      // Add a pointer to the scene\n\n      var pointer = new Three.Object3D();\n      pointer.name = 'pointer';\n\n      var pointerMaterial = new Three.MeshBasicMaterial({ depthTest: false, depthWrite: false, color: SharedStyle.COLORS.black });\n      var pointerGeometry1 = new Three.Geometry();\n      pointerGeometry1.vertices.push(new Three.Vector3(-10, 0, 0));\n      pointerGeometry1.vertices.push(new Three.Vector3(10, 0, 0));\n\n      var linePointer1 = new Three.Line(pointerGeometry1, pointerMaterial);\n      linePointer1.position.z -= 100;\n\n      var pointerGeometry2 = new Three.Geometry();\n      pointerGeometry2.vertices.push(new Three.Vector3(0, 10, 0));\n      pointerGeometry2.vertices.push(new Three.Vector3(0, -10, 0));\n\n      var linePointer2 = new Three.Line(pointerGeometry2, pointerMaterial);\n      linePointer2.renderDepth = 1e20;\n      linePointer2.position.z -= 100;\n\n      var pointerGeometry3 = new Three.Geometry();\n      pointerGeometry3.vertices.push(new Three.Vector3(-1, 1, 0));\n      pointerGeometry3.vertices.push(new Three.Vector3(1, 1, 0));\n      pointerGeometry3.vertices.push(new Three.Vector3(1, -1, 0));\n      pointerGeometry3.vertices.push(new Three.Vector3(-1, -1, 0));\n      pointerGeometry3.vertices.push(new Three.Vector3(-1, 1, 0));\n\n      var linePointer3 = new Three.Line(pointerGeometry3, pointerMaterial);\n      linePointer3.position.z -= 100;\n\n      pointer.add(linePointer1);\n      pointer.add(linePointer2);\n      pointer.add(linePointer3);\n\n      camera.add(pointer); // Add the pointer to the camera\n\n\n      // OBJECT PICKING\n      var toIntersect = [this.planData.plan];\n\n      var mouseVector = new Three.Vector2(0, 0);\n      var raycaster = new Three.Raycaster();\n\n      this.firstPersonMouseDown = function (event) {\n\n        // First of all I check if controls are enabled\n\n        if (_this2.controls.enabled) {\n          event.preventDefault();\n\n          /* Per avere la direzione da assegnare al raycaster, chiamo il metodo getDirection di PointerLockControls,\n           * che restituisce una funzione che a sua volta prende un vettore, vi scrive i valori degli oggetti\n           * pitch e yaw e lo restituisce */\n\n          raycaster.setFromCamera(mouseVector, camera);\n\n          var intersects = raycaster.intersectObjects(toIntersect, true);\n          if (intersects.length > 0 && !isNaN(intersects[0].distance)) {\n            intersects[0].object.interact && intersects[0].object.interact();\n          } else {\n            _this2.context.projectActions.unselectAll();\n          }\n        }\n      };\n\n      document.addEventListener('mousedown', this.firstPersonMouseDown, false);\n\n      this.renderer.domElement.style.display = 'block';\n\n      // add the output of the renderer to the html element\n      canvasWrapper.appendChild(this.renderer.domElement);\n      this.renderer.autoClear = false;\n\n      var render = function render() {\n\n        if (!_this2.stopRendering) {\n          yInitialPosition = _this2.planData.boundingBox.min.y + humanHeight;\n\n          var multiplier = 5;\n\n          var time = performance.now();\n          var delta = (time - prevTime) / 1000 * multiplier;\n\n          velocity.x -= velocity.x * 10.0 * delta;\n          velocity.z -= velocity.z * 10.0 * delta;\n          velocity.y -= 9.8 * 100.0 * delta / multiplier; // 100.0 = mass\n\n          direction.z = Number(moveForward) - Number(moveBackward);\n          direction.x = Number(moveLeft) - Number(moveRight);\n          direction.normalize(); // this ensures consistent movements in all directions\n\n          if (moveForward || moveBackward) velocity.z -= direction.z * 400.0 * delta;\n          if (moveLeft || moveRight) velocity.x -= direction.x * 400.0 * delta;\n\n          _this2.controls.getObject().translateX(velocity.x * delta);\n          _this2.controls.getObject().translateY(velocity.y * delta);\n          _this2.controls.getObject().translateZ(velocity.z * delta);\n\n          if (_this2.controls.getObject().position.y < yInitialPosition) {\n            velocity.y = 0;\n            _this2.controls.getObject().position.y = yInitialPosition;\n            canJump = true;\n          }\n\n          prevTime = time;\n\n          // Set light position\n          var controlObjectPosition = _this2.controls.getObject().position;\n          pointLight.position.set(controlObjectPosition.x, controlObjectPosition.y, controlObjectPosition.z);\n\n          for (var elemID in _this2.planData.sceneGraph.LODs) {\n            _this2.planData.sceneGraph.LODs[elemID].update(camera);\n          }\n\n          _this2.renderer.clear(); // clear buffers\n          _this2.renderer.render(scene3D, camera); // render scene 1\n          _this2.renderer.clearDepth(); // clear depth buffer\n          _this2.renderer.render(sceneOnTop, camera); // render scene 2\n\n          requestAnimationFrame(render);\n        }\n      };\n\n      render();\n\n      this.camera = camera;\n      this.scene3D = scene3D;\n      this.sceneOnTop = sceneOnTop;\n      // this.planData = planData;\n    }\n  }, {\n    key: 'componentWillUnmount',\n    value: function componentWillUnmount() {\n      this.stopRendering = true;\n      this.renderer.autoClear = true;\n      document.removeEventListener('mousedown', this.firstPersonMouseDown);\n      document.removeEventListener('keydown', this.keyDownEvent);\n      document.removeEventListener('keyup', this.keyUpEvent);\n      document.removeEventListener('pointerlockchange', this.pointerlockChangeEvent);\n      document.removeEventListener('mozpointerlockchange', this.pointerlockChangeEvent);\n      document.removeEventListener('webkitpointerlockchange', this.pointerlockChangeEvent);\n      this.renderer.domElement.removeEventListener('click', this.requestPointerLockEvent);\n\n      disposeScene(this.scene3D);\n\n      this.scene3D.remove(this.planData.plan);\n\n      this.scene3D = null;\n      this.planData = null;\n      this.renderer.renderLists.dispose();\n    }\n  }, {\n    key: 'componentWillReceiveProps',\n    value: function componentWillReceiveProps(nextProps) {\n      var width = nextProps.width,\n          height = nextProps.height;\n      var camera = this.camera,\n          renderer = this.renderer,\n          scene3D = this.scene3D,\n          sceneOnTop = this.sceneOnTop,\n          planData = this.planData;\n\n\n      var actions = {\n        areaActions: this.context.areaActions,\n        holesActions: this.context.holesActions,\n        itemsActions: this.context.itemsActions,\n        linesActions: this.context.linesActions,\n        projectActions: this.context.projectActions\n      };\n\n      this.width = width;\n      this.height = height;\n\n      camera.aspect = width / height;\n\n      camera.updateProjectionMatrix();\n\n      if (nextProps.scene !== this.props.state.scene) {\n        var changedValues = diff(this.props.state.scene, nextProps.state.scene);\n        updateScene(planData, nextProps.state.scene, this.props.state.scene, changedValues.toJS(), actions, this.context.catalog);\n      }\n\n      renderer.setSize(width, height);\n      renderer.clear(); // clear buffers\n      renderer.render(scene3D, camera); // render scene 1\n      renderer.clearDepth(); // clear depth buffer\n      renderer.render(sceneOnTop, camera); // render scene 2\n    }\n  }, {\n    key: 'render',\n    value: function render() {\n      return React.createElement(\"div\", {\n        ref: \"canvasWrapper\"\n      });\n    }\n  }]);\n\n  return Viewer3DFirstPerson;\n}(React.Component);\n\nexport default Viewer3DFirstPerson;\n\n\nViewer3DFirstPerson.propTypes = {\n  state: PropTypes.object.isRequired,\n  width: PropTypes.number.isRequired,\n  height: PropTypes.number.isRequired\n};\n\nViewer3DFirstPerson.contextTypes = {\n  areaActions: PropTypes.object.isRequired,\n  holesActions: PropTypes.object.isRequired,\n  itemsActions: PropTypes.object.isRequired,\n  linesActions: PropTypes.object.isRequired,\n  projectActions: PropTypes.object.isRequired,\n  catalog: PropTypes.object\n};"]},"metadata":{},"sourceType":"module"}